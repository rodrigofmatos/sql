USE FPW5
drop table if EXISTS #func

SELECT DISTINCT
	ISNULL((select TOP 1 VAVALEVENT from VALano where VACODEVENT = 11000 AND VACODEMP = F.FUCODEMP AND VACODFOLHA = 1 AND VAMATFUNC = F.FUMATFUNC AND VADTREFER = (SELECT TOP 1 VADTREFER FROM VALANO WHERE VAMATFUNC = F.FUMATFUNC AND VACODEMP = F.FUCODEMP AND VACODEVENT = 11000 AND VACODFOLHA = 1 ORDER BY VADTREFER DESC)),0) SAL_CONTRATUAL,
	(SELECT EMNOMEMP FROM EMPRESAS WHERE EMCODEMP = F.FUCODEMP) + FORMAT([FUCODEMP],' - 00') EMPRESA
	,FORMAT([FUCPF],'000\.000\.000\-00') CPF
	,[FUNOMFUNC] + FORMAT([FUMATFUNC],' - 000') FUNCIONARIO
	,(SELECT CCDESCRIC FROM CENCUSTO C WHERE C.CCCODEMP = F.FUCODEMP AND C.CCCODIGO = F.FUCENTRCUS) CENTRO_CUSTO
	,(SELECT CADESCARGO FROM CARGOS G WHERE G.CACODCARGO = F.FUCODCARGO AND G.CACODEMP = F.FUCODEMP) CARGO
	,(SELECT STDESCSITU FROM FPW5..SITUACAO WHERE STCODSITU = F.[FUCODSITU]) SITUACAO
    ,FUCBO CBOCOD
    ,CBODESCRIC CBONOM
	,CONVERT(DATETIME,CONCAT(LEFT(CAST(CONVERT(INT,F.[FUDTADMIS]) AS NVARCHAR(MAX)),4),'-',SUBSTRING(CAST(CONVERT(INT,F.[FUDTADMIS]) AS NVARCHAR(MAX)),5,2),'-',RIGHT(CAST(CONVERT(INT,F.[FUDTADMIS]) AS NVARCHAR(MAX)),2))) DTADMISSAO
INTO #FUNC
FROM 
	[FPW5].[dbo].[FUNCIONA] F INNER join
	[FPW5].[dbo].[CBO] C on c.CBOCODIGO = f.FUCBO
where 
	[FUCODEMP] NOT IN (1,11) AND 
	[FUINDADMISSAO] = 1 AND 
	(SELECT CONCAT(FORMAT(FUCPF,'00000000000'), FORMAT(MAX(FUDTINISIT),'00000000'),FORMAT(MAX(FUDTADMIS),'00000000')) FROM FPW5..FUNCIONA WHERE FUCPF = F.FUCPF GROUP BY FUCPF) = CONCAT(FORMAT(FUCPF,'00000000000'),FORMAT((FUDTINISIT),'00000000'),FORMAT((FUDTADMIS),'00000000')) AND
	[FUCODSITU] IN (SELECT STCODSITU FROM FPW5..SITUACAO WHERE NOT (STDESCSITU LIKE '%RESC%' OR STDESCSITU LIKE '%TERM%'  OR STDESCSITU LIKE '%ESTAG%'))


SELECT 
	EMPRESA,
	CPF,
	FUNCIONARIO,
	CENTRO_CUSTO,
	CARGO,
	SITUACAO,
    CBOCOD,
    CBONOM,
	format(DTADMISSAO,'dd/MM/yyyy') DTADMISSAO,
	CASE	
		WHEN DATEDIFF(year,DTADMISSAO,getdate()) = 0 then 
			case
				when DATEDIFF(month,DTADMISSAO,getdate()) = 0 then 
					case
						when DATEDIFF(day,DTADMISSAO,getdate()) = 1 then concat(DATEDIFF(day,DTADMISSAO,getdate()),' dia')
						else concat(DATEDIFF(day,DTADMISSAO,getdate()),' dias') end
				when DATEDIFF(month,DTADMISSAO,getdate()) = 1 then concat(DATEDIFF(month,DTADMISSAO,getdate()),' mï¿½s')
				else concat(DATEDIFF(month,DTADMISSAO,getdate()),' meses')
			end
		WHEN DATEDIFF(year,DTADMISSAO,getdate()) = 1 then concat(DATEDIFF(year,DTADMISSAO,getdate()),' ano')
		else concat(DATEDIFF(year,DTADMISSAO,getdate()),' anos')
	END TEMPO_DE_CASA,
	SAL_CONTRATUAL
FROM #FUNC
